<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Using the Socrata API  " />
  <meta name="copyright" content="<span class='footer-right'><a href='../acknowledgements.html'>Acknowledgements</a></span><span class='footer-right'><a href=' https://etherpad.wikimedia.org/p/rspatial-bgs24 ' target='_blank'>Forum</a></span><span class='footer-right'><a href=' https://ajlyons.github.io/rspatial_bgs24 '> https://ajlyons.github.io/rspatial_bgs24 </a></span><span class='footer-right'><a href='../index.html'>Home</a></span><span class='footer-subtitle'> R for GIS </span>"/>
  <meta name="font-size-adjustment" content="2"/>
  <title>R for GIS  BayGeo, Spring 2024</title>
  <style type="text/css">
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
            pre > code.sourceCode { white-space: pre; position: relative; }
            pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
            pre > code.sourceCode > span:empty { height: 1.2em; }
            .sourceCode { overflow: visible; }
            code.sourceCode > span { color: inherit; text-decoration: inherit; }
            div.sourceCode { margin: 1em 0; }
            pre.sourceCode { margin: 0; }
            @media screen {
            div.sourceCode { overflow: auto; }
            }
            @media print {
            pre > code.sourceCode { white-space: pre-wrap; }
            pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
            }
            pre.numberSource code
              { counter-reset: source-line 0; }
            pre.numberSource code > span
              { position: relative; left: -4em; counter-increment: source-line; }
            pre.numberSource code > span > a:first-child::before
              { content: counter(source-line);
                position: relative; left: -1em; text-align: right; vertical-align: baseline;
                border: none; display: inline-block;
                -webkit-touch-callout: none; -webkit-user-select: none;
                -khtml-user-select: none; -moz-user-select: none;
                -ms-user-select: none; user-select: none;
                padding: 0 4px; width: 4em;
                color: #aaaaaa;
              }
            pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
            div.sourceCode
              {   }
            @media screen {
            pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
            }
            code span.al { color: #ff0000; font-weight: bold; } /* Alert */
            code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
            code span.at { color: #7d9029; } /* Attribute */
            code span.bn { color: #40a070; } /* BaseN */
            code span.bu { color: #008000; } /* BuiltIn */
            code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
            code span.ch { color: #4070a0; } /* Char */
            code span.cn { color: #880000; } /* Constant */
            code span.co { color: #60a0b0; font-style: italic; } /* Comment */
            code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
            code span.do { color: #ba2121; font-style: italic; } /* Documentation */
            code span.dt { color: #902000; } /* DataType */
            code span.dv { color: #40a070; } /* DecVal */
            code span.er { color: #ff0000; font-weight: bold; } /* Error */
            code span.ex { } /* Extension */
            code span.fl { color: #40a070; } /* Float */
            code span.fu { color: #06287e; } /* Function */
            code span.im { color: #008000; font-weight: bold; } /* Import */
            code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
            code span.kw { color: #007020; font-weight: bold; } /* Keyword */
            code span.op { color: #666666; } /* Operator */
            code span.ot { color: #007020; } /* Other */
            code span.pp { color: #bc7a00; } /* Preprocessor */
            code span.sc { color: #4070a0; } /* SpecialChar */
            code span.ss { color: #bb6688; } /* SpecialString */
            code span.st { color: #4070a0; } /* String */
            code span.va { color: #19177c; } /* Variable */
            code span.vs { color: #4070a0; } /* VerbatimString */
            code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
          </style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACkUlEQVQ4jX2SW0jTcRTHTzNyeZlh6lqmm3POdNPC6SxSEzaqafkykOFoIxTDWpKRFV6iQMNLFyMSsQvUW0WORc2WWBmGKEGZXUyz0NrmNmfa1PYgfHsQ1v5oHjgvX875/M45vy/R8mDJ9caxrFIL5CUWJB00Q9n+7Q+l1BetUMuMTL3JpTB0QVnejd1Hu9DQ60G5eQbqB7PIvj0L2bUZ0KZzghWbs0o7Fx3Tc/B6vStm6+g0wrQvIKh2gKKyUxnNSZoO685SC1YDeL1e9Ll+Ia7WCd5pJ4hojQ8g1nViezETYBqZx93BOdwa9jAgsdUT4J6ZQqC6f4GIiLYU9/RzNWYIdU9hd/8rLjN7UGT8DbWROVVMlQsBBWas142DiIikdfbFMF0POIVm2NzM1zwLS+mvcSsnEajpBSv/8RIgucGJ1EYXEs+NwjrlWfUGMee/Y2PFJIJLrFibex8kOsahhCYnUlpnIL1kh9X9/yMKG2yIOOlAsPYnAveZsE75EEQUQLwTwy5Rsxvx9UxApKEPEYY+BiSizA623oaggkdgq4xLKwRLq7i8sy6EFlpg8wNEVwyAd3wAbZ8cPu3CazeCC/sRojYjaL8Jvm8MPWLDBm03A8CveQ9+7RBia4cYU4QfeokwzTOwc6/4OzKXHap/C5ufD0RNo0i4OAZR81dcnnD69Mp3PxBe9GRkuZdFKk7sqTcQ132EpGUMydetSLnpgOSGHVtbxpHU9AX8mkFEG55/ZrjQL1h82V6esPLVh8Sr40i940J6xzzS7s1C0m6HqHEEiTnatgT5gcPijHxltFwhjpRIQpZjBAJ2lFTBFW5TiOPT8mXx6apdcRl5OaJM1Q6hLC9ls3RPTLgok0NELCKiv02kPqt/O1MZAAAAAElFTkSuQmCC" rel="icon" type="image/x-icon" />
  <meta name="robots" content="noindex,nofollow"/>
  <script language="javascript" type="text/javascript">
  function TriShowHide(shID) {
    shIDspan = shID + "span";
    shIDdiv = shID + "div";
    if (document.getElementById(shIDdiv).style.display != 'block') {
      document.getElementById(shIDdiv).style.display = 'block';
      txtSpan = "&#9660;";
    } else {
      document.getElementById(shIDdiv).style.display = 'none';
      txtSpan = "&#9654;";
    }
    document.getElementById(shIDspan).innerHTML = txtSpan + " ";
  }
  function showHide(shID) {
    if (shID=="soln-show-all") {
      var allAnswerCode = document.getElementsByClassName("answer-code");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'block';
      }
    } else if (shID=="soln-hide-all") {
      var allAnswerCode = document.getElementsByClassName("answer-code");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'none';
      }
    } else if (shID=="hints-show-all") {
      var allAnswerCode = document.getElementsByClassName("hint");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'block';
      }
    } else if (shID=="hints-hide-all") {
      var allAnswerCode = document.getElementsByClassName("hint");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'none';
      }
    } else {
      if (document.getElementById(shID)) {
        if (document.getElementById(shID).style.display != 'block') {
          document.getElementById(shID).style.display = 'block';
        } else {
          document.getElementById(shID).style.display = 'none';
        }
      }
    }
  }
  function CopyToClipboard(containerid) {
  if (document.selection) {
      var range = document.body.createTextRange();
      range.moveToElementText(document.getElementById(containerid));
      range.select().createTextRange();
      document.execCommand("copy");
  } else if (window.getSelection) {
      var range = document.createRange();
      range.selectNode(document.getElementById(containerid));
      window.getSelection().addRange(range);
      document.execCommand("copy");
      // alert("text copied")
  }}
  </script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-163964617-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-163964617-1');
  </script>
  <script src="lib/header-attrs-2.25/header-attrs.js"></script>
  <link href="lib/slidy-2/styles/slidy.css" rel="stylesheet" />
  <script src="lib/slidy-2/scripts/slidy.js"></script>
  <script src="lib/slidy_shiny-1/slidy_shiny.js"></script>
  <script src="lib/clipboard-1.7.1/clipboard.min.js"></script>
  <link href="lib/primer-tooltips-1.4.0/build.css" rel="stylesheet" />
  <link href="lib/klippy-0.0.0.9500/css/klippy.min.css" rel="stylesheet" />
  <script src="lib/klippy-0.0.0.9500/js/klippy.min.js"></script>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
   href="../css/slidy_styles.css" />
  <meta name="duration" content="0" />
</head>
<body>
<script type="text/javascript">w3c_slidy.mouse_click_enabled = false;</script>
<div class="slide titlepage">
  <h1 class="title"><span class="course-title">R for GIS
</span><br/><span class="course-subtitle">BayGeo, Spring
2024</span></h1>
  <p class="author">
Using the Socrata API <br/><img src='images/soda-api_400x174.png'/>
  </p>
</div>
<div id="socrata-api" class="slide section level1">
<h1>Socrata API</h1>
<script language="javascript" type="text/javascript">w3c_slidy.mouse_click_enabled = false;</script>
<script>
  addKlippy('left', 'top', 'auto', '1', 'Copy code', 'Copied!');
</script>
<p>The Socrata Open Data API (SODA) allows you to programmatically
access a wealth of open data resources.</p>
<p>Used by governments, non-profits, and NGOs around the world.</p>
<p><a href="https://datasf.org/" target="_blank">DataSF.org</a> is built
upon <a href="https://dev.socrata.com/" target="_blank">Socrata Open
Data</a>.</p>
<p>Important concept: Every dataset has its own URL or endpoint:</p>
<div class="indented1">
<p><strong>Human-readable URL: (aka Data Page)</strong><br />
<a
href="https://soda.demo.socrata.com/dataset/USGS-Earthquakes-for-2012-11-01-API/4334-bgaj"
target="_blank">https://soda.demo.socrata.com/dataset/USGS-Earthquakes-for-2012-11-01-API/4334-bgaj</a></p>
<p><strong>SoDA URL (this is what you use to import into
R)</strong><br />
<a href="http://soda.demo.socrata.com/resource/4334-bgaj.csv"
target="_blank">http://soda.demo.socrata.com/resource/4334-bgaj.csv</a><br />
<a href="https://data.ct.gov/resource/y6p2-px98.json"
target="_blank">https://data.ct.gov/resource/y6p2-px98.json</a></p>
</div>
</div>
<div id="getting-the-api-endpoint-url-for-a-dataset"
class="slide section level1">
<h1>Getting the API Endpoint (URL) for a Dataset</h1>
<p><img src="images/sodi_api_url_762x428.png" style="height:300;"></p>
<div class="tip">
<p>Take note of the extension (csv, json, geojson, etc.). This will tell
you which function(s) you’ll need to import it.</p>
</div>
<!--- tip --->
</div>
<div id="importing-tabular-data-with-rsocrata"
class="slide section level1">
<h1>Importing Tabular Data with RSocrata</h1>
<p>The <a href="https://github.com/Chicago/RSocrata"
target="_blank"><tt>RSocrata</tt> package</a> was developed by the City
of Chicago. It has functions to import data from a SODA API
endpoint.</p>
<p>First install RSocrata from CRAN or GitHub (requires
<strong>remotes</strong>, see below):</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb1"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;Chicago/RSocrata&quot;</span>)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(RSocrata)</span></code></pre></div>
</div>
<p><br />
</p>
<p>The main function to read in tabular data is:</p>
<div class="indented3">
<tt><strong>read.socrata(<em>url</em>)</strong></tt>
</div>
<h3 id="example-import-earthquake-data">Example: Import Earthquake
Data</h3>
<p>Let’s import a sample dataset of earthquake locations using the SODA
API</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb2"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="do">## Import earthquake locations for one week in September 2012</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>earthquakes_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(<span class="st">&quot;http://soda.demo.socrata.com/resource/4334-bgaj.csv&quot;</span>)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="fu">glimpse</span>(earthquakes_df)</span></code></pre></div>
<pre><code>## Rows: 1,007
## Columns: 9
## $ source             &lt;chr&gt; &quot;nn&quot;, &quot;ci&quot;, &quot;nc&quot;, &quot;nn&quot;, &quot;nn&quot;, &quot;pr&quot;, &quot;hv&quot;, &quot;hv&quot;, &quot;nc&quot;, &quot;nc&quot;, &quot;ak&quot;, &quot;pr&quot;, &quot;nc&quot;, &quot;nc&quot;, &quot;ci&quot;, &quot;ci&quot;, &quot;…
## $ earthquake_id      &lt;chr&gt; &quot;00388610&quot;, &quot;15215753&quot;, &quot;71842370&quot;, &quot;00388609&quot;, &quot;00388607&quot;, &quot;12258012&quot;, &quot;60397836&quot;, &quot;60397821&quot;, &quot;…
## $ version            &lt;chr&gt; &quot;9&quot;, &quot;0&quot;, &quot;0&quot;, &quot;9&quot;, &quot;9&quot;, &quot;0&quot;, &quot;2&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0…
## $ datetime           &lt;dttm&gt; 2012-09-14 22:38:01, 2012-09-14 22:14:45, 2012-09-14 22:14:21, 2012-09-14 22:10:19, 2012-09-14 2…
## $ magnitude          &lt;dbl&gt; 2.7, 1.5, 1.4, 1.5, 1.7, 3.1, 1.8, 2.3, 1.6, 2.3, 2.4, 3.3, 1.0, 1.9, 1.3, 2.3, 1.4, 1.6, 1.5, 1.…
## $ depth              &lt;dbl&gt; 7.6, 10.6, 0.0, 8.2, 6.4, 20.0, 6.0, 30.8, 2.1, 27.8, 3.2, 74.0, 8.5, 2.6, 3.4, 6.9, 8.6, 10.3, 4…
## $ number_of_stations &lt;int&gt; 15, 35, 21, 29, 29, 6, 17, 36, 29, 13, 30, 4, 17, 10, 39, 108, 19, 13, 53, 14, 6, 16, 26, 15, 17,…
## $ region             &lt;chr&gt; &quot;Nevada&quot;, &quot;Southern California&quot;, &quot;Northern California&quot;, &quot;Central California&quot;, &quot;Central California…
## $ location           &lt;chr&gt; &quot;(41.1085, -117.6135)&quot;, &quot;(34.525, -118.1527)&quot;, &quot;(38.8023, -122.7685)&quot;, &quot;(36.9447, -117.6778)&quot;, &quot;(…</code></pre>
</div>
<p><br />
</p>
<h3 id="example-filming-locations-in-sf">Example: Filming Locations in
SF</h3>
<p><strong>json</strong> is another common file format for data, and is
often used to save tabular data.</p>
<p>Let’s load the <a
href="https://data.sfgov.org/Culture-and-Recreation/Film-Locations-in-San-Francisco/yitu-d5am"
target="_blank">movie locations dataset</a> from SF Data.</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb4"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>movie_loc_url <span class="ot">&lt;-</span> <span class="st">&quot;https://data.sfgov.org/resource/wwmu-gmzc.json&quot;</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>movie_loc_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(movie_loc_url)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="fu">glimpse</span>(movie_loc_df)</span></code></pre></div>
</div>
<div class="indented2 indented2r">
<pre><code>## Rows: 2,084
## Columns: 11
## $ title              &lt;chr&gt; &quot;The Enforcer&quot;, &quot;Quitters&quot;, &quot;A Jitney Elopement&quot;, &quot;A Jitney Elopement&quot;, &quot;All About Eve&quot;, &quot;D.O.A&quot;,…
## $ release_year       &lt;chr&gt; &quot;1976&quot;, &quot;2015&quot;, &quot;1915&quot;, &quot;1915&quot;, &quot;1950&quot;, &quot;1950&quot;, &quot;1980&quot;, &quot;1950&quot;, &quot;1971&quot;, &quot;1924&quot;, &quot;2020&quot;, &quot;1971&quot;, &quot;…
## $ locations          &lt;chr&gt; &quot;Hall of Justice&quot;, &quot;Wine Impression&quot;, &quot;20th and Folsom Streets&quot;, &quot;Golden Gate Park&quot;, &quot;Curran Thea…
## $ production_company &lt;chr&gt; &quot;Warner Bros. Pictures&quot;, &quot;Frederick &amp; Ashbury, LLC.&quot;, &quot;The Essanay Film Manufacturing Company&quot;, &quot;…
## $ distributor        &lt;chr&gt; &quot;Warner Bros. Pictures&quot;, NA, &quot;General Film Company&quot;, &quot;General Film Company&quot;, &quot;Twentieth Century F…
## $ director           &lt;chr&gt; &quot;James Fargo&quot;, &quot;Noah Pritzker&quot;, &quot;Charles Chaplin&quot;, &quot;Charles Chaplin&quot;, &quot;Joseph L. Mankiewicz&quot;, &quot;Ru…
## $ writer             &lt;chr&gt; &quot;Stirling Silliphant&quot;, &quot;Noah Pritzker&quot;, &quot;Charles Chaplin&quot;, &quot;Charles Chaplin&quot;, &quot;Joseph L. Mankiewi…
## $ actor_1            &lt;chr&gt; &quot;Clint Eastwood&quot;, &quot;Kara Hayward&quot;, &quot;Charles Chaplin&quot;, &quot;Charles Chaplin&quot;, &quot;Bette Davis&quot;, &quot;Edmond O&#39;…
## $ actor_2            &lt;chr&gt; &quot;Tyne Daly&quot;, &quot;Mira Sorvino&quot;, &quot;Edna Purviance&quot;, &quot;Edna Purviance&quot;, &quot;Anne Baxter&quot;, &quot;Pamela Britton&quot;,…
## $ actor_3            &lt;chr&gt; &quot;Harry Guardino&quot;, &quot;Saffron Burrows&quot;, NA, NA, &quot;George Sanders&quot;, &quot;Luther Adler&quot;, &quot;Felipe Rose&quot;, &quot;Lu…
## $ fun_facts          &lt;chr&gt; NA, NA, NA, &quot;During San Francisco&#39;s Gold Rush era, the Park was part of an area designated as the…</code></pre>
</div>
<p><br />
</p>
</div>
<div id="api-tokens" class="slide section level1">
<h1>API Tokens</h1>
<p>Many organizations that share data or computing services use
<strong>API tokens</strong> or <strong>keys</strong> to manage demand on
their servers, and/or enforce a usage policy. A token is a seemingly
random series of character, a little bit like a password.</p>
<div class="infobox">
<p>SFData.org does not require tokens, but you can get throttled if too
many people use it at once. Create a token at the <a
href="http://datasf.org/opendata/developers" target="_blank">Developer
Portal</a>.</p>
</div>
<!--- info-box --->
<p>If you have an API token, you can send it using the optional
<tt><strong>app_token</strong></tt> argument.</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>movie_loc_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(movie_loc_url, <span class="at">app_token=</span><span class="st">&quot;1234-not-real-token-wxyz&quot;</span>)</span></code></pre></div>
</div>
<p><br />
</p>
<div class="tip">
<p><strong>API Token Security</strong></p>
<p>Because APIs are like passwords, and in some cases are connected to a
credit card, it’s not wise to enter a token in any code that will be
shared. For tips on how to protect your API key, see the <a
href="geocoding.html#protecting-your-api-key"
target="_blank">Geocoding</a> slides.</p>
</div>
<!--- tip --->
</div>
<div id="importing-polygon-data" class="slide section level1">
<h1>Importing Polygon Data</h1>
<p><a
href="https://data.sfgov.org/Geographic-Locations-and-Boundaries/Analysis-Neighborhoods/p5b7-5n3h"
target="_blank">Neighborhood boundaries</a> can be imported as well. The
SODA rest end point is:</p>
<div class="indented2">
<tt><a href="https://data.sfgov.org/resource/xfcw-9evu.json"
class="uri">https://data.sfgov.org/resource/xfcw-9evu.json</a></tt>
</div>
<p>Note the extension: <tt><strong>json</strong></tt>. The json format
is only for tabular data, which means this is <strong>just the attribute
table</strong>.</p>
<p>To get the <strong>points / lines / polygons</strong>, you need
to:</p>
<div class="indented2 compact">
<ol style="list-style-type: decimal">
<li>Make sure it’s actually a spatial dataset (look for a field called
geom).<br />
</li>
<li>Manually change the extension in the URL from <tt>json</tt> to
<tt><strong>geojson</strong></tt>.<br />
</li>
<li>Use <tt><strong><tt>sf::read_sf()</tt></strong></tt> instead of
<tt>read.socrata()</tt>.</li>
<li>Make sure to use <tt>URLencode()</tt> if the URL has spaces in
it.</li>
</ol>
</div>
<h3 id="example-import-neighborhood-boundaries">Example: Import
Neighborhood Boundaries</h3>
<p>Let’s import <a
href="https://data.sfgov.org/-/Analysis-Neighborhoods/j2bu-swwd/about_data"
target="_blank">SF Neighborhood Boundaries</a>, using the URL above but
changing the extension to <tt>geojson</tt>.</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb7"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>nb_bnd <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;https://data.sfgov.org/resource/j2bu-swwd.geojson&quot;</span> <span class="sc">|&gt;</span> <span class="fu">URLencode</span>())</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="fu">plot</span>(nb_bnd[<span class="st">&#39;nhood&#39;</span>])</span></code></pre></div>
<p><img src="socrata-api_files/figure-slidy/load_nb_klippy-1.png" width="768" /></p>
</div>
<p><br />
</p>
</div>
<div id="adding-query-parameters-to-an-api-call"
class="slide section level1">
<h1>Adding Query Parameters to an API Call</h1>
<p>Query parameters are added on to the end of a SODA URL, usually
starting with the ‘<tt><strong>?</strong></tt>’ character.</p>
<p>For example the query parameter below:</p>
<div class="indented3">
<p><tt><a href="https://data.sfgov.org/resource/wwmu-gmzc.json"
class="uri">https://data.sfgov.org/resource/wwmu-gmzc.json</a><strong>?release_year=2011</strong></tt></p>
</div>
<p>…tells the server that you only want film locations for movies that
were released in 2011.</p>
<p>There are many reasons why you may want to use query parameters:</p>
<div class="indented1">
<ul>
<li>You may only be interested in a subset of the data.<br />
</li>
<li>The source may contain millions of rows, which would be difficult if
not impossible to download entirely.<br />
</li>
<li>The dataset may contain a lot of columns that you don’t need and
would just be wasted bandwidth to download.<br />
</li>
<li>You may only want summaries of the data, for example the sum of
something for groups of rows. With the right query parameters, the
server will do these calculations for you.<br />
</li>
</ul>
</div>
<div class="tip compact">
<p>To add query parameters, you need to get familiar with the columns in
the dataset.</p>
<ul>
<li>How are they spelled (exactly)?<br />
</li>
<li>What data type are they (i.e., text, integer, double, floating
timestamp, <a href="https://dev.socrata.com/docs/datatypes/"
target="_blank">more</a>)?<br />
</li>
<li>Do they contain codes or abbreviations?</li>
</ul>
</div>
<!--- tip --->
</div>
<div id="a-simple-query" class="slide section level1">
<h1>A Simple Query</h1>
<p>You can specify a <strong>simple filter</strong> when you import the
data by adding a column name and value at the end the of the URL.</p>
<p>Query parameters should always start with
‘<tt><strong>?</strong></tt>’</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb8"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="do">## Add a simple parameter query to import 2008 films only </span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>movie2008_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(<span class="st">&quot;https://data.sfgov.org/resource/wwmu-gmzc.json?release_year=2008&quot;</span>)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="fu">glimpse</span>(movie2008_df)</span></code></pre></div>
<PRE class="fansi fansi-output"><CODE>## Rows: 12
## Columns: 10
## $ title              <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;Milk&quot;, &quot;Milk&quot;, &quot;Milk&quot;, &quot;Milk&quot;, &quot;Milk&quot;, &quot;Milk&quot;, &quot;Milk&quot;, &quot;Milk&quot;, &quot;Milk&quot;, &quot;Milk&quot;, &quot;Milk&quot;, &quot;Milk&quot;
## $ release_year       <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;2008&quot;, &quot;2008&quot;, &quot;2008&quot;, &quot;2008&quot;, &quot;2008&quot;, &quot;2008&quot;, &quot;2008&quot;, &quot;2008&quot;, &quot;2008&quot;, &quot;2008&quot;, &quot;2008&quot;, &quot;2008&quot;
## $ locations          <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;Duboce Park&quot;, &quot;City Hall&quot;, &quot;Chinatown&quot;, &quot;424 Sansome Street&quot;, &quot;29th and Dolores Street&quot;, &quot;El Cam…
## $ production_company <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;Focus Features&quot;, &quot;Focus Features&quot;, &quot;Focus Features&quot;, &quot;Focus Features&quot;, &quot;Focus Features&quot;, &quot;Focus …
## $ distributor        <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;Focus Features&quot;, &quot;Focus Features&quot;, &quot;Focus Features&quot;, &quot;Focus Features&quot;, &quot;Focus Features&quot;, &quot;Focus …
## $ director           <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;Gus Van Sant&quot;, &quot;Gus Van Sant&quot;, &quot;Gus Van Sant&quot;, &quot;Gus Van Sant&quot;, &quot;Gus Van Sant&quot;, &quot;Gus Van Sant&quot;, &quot;…
## $ writer             <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;Dustin Lance Black&quot;, &quot;Dustin Lance Black&quot;, &quot;Dustin Lance Black&quot;, &quot;Dustin Lance Black&quot;, &quot;Dustin L…
## $ actor_1            <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;Sean Penn&quot;, &quot;Sean Penn&quot;, &quot;Sean Penn&quot;, &quot;Sean Penn&quot;, &quot;Sean Penn&quot;, &quot;Sean Penn&quot;, &quot;Sean Penn&quot;, &quot;Sean …
## $ actor_2            <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;Emile Hirsch&quot;, &quot;Emile Hirsch&quot;, &quot;Emile Hirsch&quot;, &quot;Emile Hirsch&quot;, &quot;Emile Hirsch&quot;, &quot;Emile Hirsch&quot;, &quot;…
## $ fun_facts          <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> NA, &quot;The dome of SF&#039;s City Hall is almost a foot taller than that of the US Capitol Building. In …
</CODE></PRE>
</div>
<p><br />
</p>
<div class="tip">
<p><strong>Query Parameter Syntax Rules</strong></p>
<p>SoQL expressions (like SQL), are generally case insensitive. This
includes field names.</p>
<p>SoQL expressions should not include spaces except when part of a
literal string, or to to set keywords apart (like AND or BETWEEN). For
legibility, you may also put spaces around operators like: <tt>= &gt;
&lt;</tt></p>
<p>Use single quotes to delineate text with embedded spaces. Field names
and text values that don’t have spaces don’t need to be quoted.</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>spi_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(<span class="st">&quot;https://data.sfgov.org/resource/wwmu-gmzc.json?production_company=&#39;SPI Cinemas&#39;&quot;</span>)</span></code></pre></div>
</div>
<p><br />
</p>
<p>Query parameter syntax can be unforgiving error messages are
generally unhelpful! A good way to learn is to start with simple queries
and build-up.</p>
</div>
<!--- tip --->
</div>
<div id="more-complex-query-parameters" class="slide section level1">
<h1>More Complex Query Parameters</h1>
<p>For queries that go beyond a simple filter, we can use the <a
href="https://dev.socrata.com/docs/queries/" target="_blank">SoQL Query
Language</a>. SoQL is similar to SQL (<a
href="http://en.wikipedia.org/wiki/Sql" target="_blank">Strctured Query
Language</a>).</p>
<p>SoQL expressions consists of one or more <a
href="https://dev.socrata.com/docs/queries/"
target="_blank">Clauses</a>. The main SoQL clauses are: <tt>WHERE</tt>,
<tt>LIMIT</tt>, <tt>SELECT</tt>, <tt>ORDER</tt>, and <tt>GROUP</tt>.</p>
<p>You add one or more SoQL clauses to the end of the URL, separating
them with <tt><strong>&amp;</strong></tt> and starting each clause with
<tt><strong>$</strong></tt></p>
<div class="indented2">
<p><tt><a href="http://"
class="uri">http://</a>…/xxxxx.json?<strong>&amp;#select</strong>=XXXXXXX<strong>&amp;#where</strong>=XXXXXX<strong>&amp;#order</strong>=XXXXXX</tt></p>
</div>
<p>To filter rows use the <a
href="https://dev.socrata.com/docs/queries/where.html"
target="_blank"><tt><strong>where</strong></tt></a> clause:</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb10"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="do">## Use a WHERE clausee to get locations for movies released in 2010</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>filmloc2010_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(<span class="st">&quot;https://data.sfgov.org/resource/wwmu-gmzc.json?$where=release_year=2010&quot;</span>)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="fu">nrow</span>(filmloc2010_df)</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="do">## For compound expressions, use the keywords AND, OR, and NOT </span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="do">## as part of the WHERE expression. Note here you need spaces.</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="do">## Get locations for movies released between 2010 AND 2013</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>filmloc2010_13_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(<span class="st">&quot;https://data.sfgov.org/resource/wwmu-gmzc.json?$where=release_year&gt;=2010 AND release_year &lt;=2013&quot;</span>)</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="fu">nrow</span>(filmloc2010_13_df)</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a><span class="do">## Because release_year is numeric, we can get the same thing </span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="do">## using the &#39;between&#39; keyword</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>filmloc201013_df2 <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(<span class="st">&quot;https://data.sfgov.org/resource/wwmu-gmzc.json?$where=release_year BETWEEN 2010 AND 2013&quot;</span>)</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a><span class="fu">nrow</span>(filmloc201013_df2)</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a><span class="do">## Filter on multiple columns</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>filmloc_hitchcock_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(<span class="st">&quot;https://data.sfgov.org/resource/wwmu-gmzc.json?$where=director=&#39;Alfred Hitchcock&#39; AND release_year=1963&quot;</span>)</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a><span class="fu">nrow</span>(filmloc_hitchcock_df)</span></code></pre></div>
<pre><code>## [1] 7
## [1] 76
## [1] 76
## [1] 1</code></pre>
</div>
<p><br />
</p>
<div class="quiz">
<p>Which film(s) did Alfred Hitchcock shoot in San Francisco in
1963?</p>
<p><span id="soln_hzblce" class="showhidesoln"
onclick="showHide(&#39;hzblce&#39;);return false;">Answer</span></p>
<div id="hzblce" class="hint">
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">unique</span>(filmloc_hitchcock_df<span class="sc">$</span>title)</span></code></pre></div>
<pre><code>## [1] &quot;The Birds&quot;</code></pre>
</div>
<!--- soln_hzblce --->
</div>
<!--- quiz --->
<p>To limit the number of records, add the
<tt><strong>limit</strong></tt> clause at the end. This is particularly
helpful when you are testing a query expression for a large dataset.</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb14"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="do">## Add the LIMIT clause to only get the top-five locations </span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>filmloc2010_five_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(<span class="st">&quot;https://data.sfgov.org/resource/wwmu-gmzc.json?$where=release_year=2010&amp;$limit=5&quot;</span>)</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>filmloc2010_five_df</span></code></pre></div>
<pre><code>##                                           title release_year       production_company           distributor        director
## 1                                        Babies         2010                   Canal+        Focus Features   Thomas Balmes
## 2                    Broken-A Modern Love Story         2010                RKW Films                  &lt;NA&gt; Ryan K. Whiting
## 3                    Broken-A Modern Love Story         2010                RKW Films                  &lt;NA&gt; Ryan K. Whiting
## 4 God is a Communist?* (show me heart universe)         2010 Trismegistus Productions                  &lt;NA&gt;   Jon Poznanter
## 5                                     Hereafter         2010                 GT Films Warner Bros. Pictures  Clint Eastwood
##            writer    actor_1          actor_2                               locations
## 1   Thomas Balmes      Bayar           Hattie                                    &lt;NA&gt;
## 2 Ryan K. Whiting       &lt;NA&gt;             &lt;NA&gt; Ina Coolbrith Park (1700 Taylor Street)
## 3 Ryan K. Whiting       &lt;NA&gt;             &lt;NA&gt;              0-100 block Halleck Street
## 4   Jon Poznanter  John Wynn             &lt;NA&gt;         Sacramento &amp; Washington Streets
## 5    Peter Morgan Matt Damon Cecile De France     Hobart Building (582 Market Street)</code></pre>
</div>
<p><br />
</p>
</div>
<div id="concatenating-text" class="slide section level1">
<h1>Concatenating Text</h1>
<p>Before we continue, let’s make our life a little easier.</p>
<p>Query parameter expressions (and REST endpoint URLs in general) can
get very long! To make them easier to both read and write, we’ll start
to construct them as separate pieces of text, then
<strong>concatenate</strong> them into the final URL.</p>
<p>In Excel and other languages, we concatenate text using
<tt><strong>&amp;</strong></tt>. For example, <tt>‘My’ &amp; ‘Dog’</tt>
becomes <tt>‘MyDog’</tt></p>
<p>In R, we concatenate text with <tt><strong>paste0()</strong></tt> and
<tt><strong>paste()</strong></tt>. Examples:</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="fu">paste0</span>(<span class="st">&quot;My&quot;</span>, <span class="st">&quot;Dog&quot;</span>, <span class="st">&quot;Has&quot;</span>, <span class="st">&quot;Fleas&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;MyDogHasFleas&quot;</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">&quot;My&quot;</span>, <span class="st">&quot;Dog&quot;</span>, <span class="st">&quot;Has&quot;</span>, <span class="st">&quot;Fleas&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;My Dog Has Fleas&quot;</code></pre>
</div>
<p><br />
</p>
<p>As you can see, <tt>paste()</tt> adds a separator character (by
default a blank space, but you can change it with an argument).
<tt><strong>paste0()</strong></tt> joins text without a separator.</p>
<div class="tip">
<p>You can also use <tt>paste0()</tt> and <tt>paste()</tt> with
piping:</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="st">&quot;My&quot;</span> <span class="sc">|&gt;</span> <span class="fu">paste0</span>(<span class="st">&quot;Dog&quot;</span>) <span class="sc">|&gt;</span> <span class="fu">paste0</span>(<span class="st">&quot;Has&quot;</span>) <span class="sc">|&gt;</span> <span class="fu">paste0</span>(<span class="st">&quot;Fleas&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;MyDogHasFleas&quot;</code></pre>
</div>
</div>
<!--- tip --->
<p><br />
</p>
</div>
<div id="complex-parameter-queries-contd" class="slide section level1">
<h1>Complex Parameter Queries (cont’d)</h1>
<p>So far we’ve written parameter queries using the <tt>WHERE</tt> and
<tt>LIMIT</tt> clauses. Next we’ll add <tt><strong>SELECT</strong></tt>,
<tt><strong>ORDER</strong></tt>, and <tt><strong>GROUP</strong></tt>
clauses.</p>
<p><tt><strong>SELECT</strong></tt> allows you to i) pick the columns
you want the server to send you, and ii) compute calculated expressions.
If present, it is usually the <strong>first clause</strong> used in a
SoQL expression.</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb22"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="do">## Define a variable for the REST Endpoint, including the &#39;?&#39;</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>movie_loc_url <span class="ot">&lt;-</span> <span class="st">&quot;https://data.sfgov.org/resource/wwmu-gmzc.json?&quot;</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="do">## Define parameter query pieces for FILTER and WHERE </span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="do">## Get just the title, release year, and director</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>pq_select <span class="ot">&lt;-</span> <span class="st">&quot;$select=release_year,title,director&quot;</span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>pq_where <span class="ot">&lt;-</span> <span class="st">&quot;&amp;$where=release_year=2016&quot;</span></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a>filmloc_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(movie_loc_url <span class="sc">|&gt;</span> </span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>                             <span class="fu">paste0</span>(pq_select, pq_where) <span class="sc">|&gt;</span> </span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a>                             <span class="fu">URLencode</span>())</span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a><span class="fu">glimpse</span>(filmloc_df)</span></code></pre></div>
<PRE class="fansi fansi-output"><CODE>## Rows: 168
## Columns: 3
## $ release_year <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;2016&quot;, &quot;2016&quot;, &quot;2016&quot;, &quot;2016&quot;, &quot;2016&quot;, &quot;2016&quot;, &quot;2016&quot;, &quot;2016&quot;, &quot;2016&quot;, &quot;2016&quot;, &quot;2016&quot;, &quot;2016&quot;, &quot;2016&quot;,…
## $ title        <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;Chance- Season 1 ep104&quot;, &quot;Birth of the Dragon&quot;, &quot;Birth of the Dragon&quot;, &quot;Birth of the Dragon&quot;, &quot;Birth o…
## $ director     <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;Carl Franklin&quot;, &quot;George Nolfi&quot;, &quot;George Nolfi&quot;, &quot;George Nolfi&quot;, &quot;George Nolfi&quot;, &quot;George Nolfi&quot;, &quot;Georg…
</CODE></PRE>
</div>
<p><br />
</p>
<div class="tip">
<p><tt>URLencode()</tt> will convert spaces in a URL to <tt>%20</tt>,
and change other special characters to other percent codes. While not
always necessary, this is good practice for URLs.</p>
</div>
<!--- tip --->
<p>You can specify the order of the rows returned by appending an
<tt><strong>ORDER</strong></tt> clause at the very end. Note the
<tt><strong>ORDER</strong></tt> expression can include fields that
aren’t selected to be part of the output.</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb23"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="do">## Specify the order of the rows returned</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>pq_select <span class="ot">&lt;-</span> <span class="st">&quot;$select=director,title&quot;</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>pq_order <span class="ot">&lt;-</span> <span class="st">&quot;&amp;$order=release_year,director&quot;</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>filmloc_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(movie_loc_url <span class="sc">|&gt;</span> </span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>                             <span class="fu">paste0</span>(pq_select, pq_where, pq_order) <span class="sc">|&gt;</span> </span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>                             <span class="fu">URLencode</span>())</span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a><span class="fu">head</span>(filmloc_df)</span></code></pre></div>
<pre><code>##                            director                  title
## 1 Alexandra Cunningham and Kem Nunn Chance- Season 1 ep107
## 2 Alexandra Cunningham and Kem Nunn Chance- Season 1 ep110
## 3 Alexandra Cunningham and Kem Nunn Chance- Season 1 ep107
## 4 Alexandra Cunningham and Kem Nunn Chance- Season 1 ep107
## 5 Alexandra Cunningham and Kem Nunn Chance- Season 1 ep107
## 6 Alexandra Cunningham and Kem Nunn Chance- Season 1 ep110</code></pre>
</div>
<p><br />
</p>
<p>If you want to remove duplicates, add
<tt><strong>distinct</strong></tt> as part of the select clause. This
will return unique combinations of the fields returned. Note: when using
distinct, you must also specify the <tt><strong>ORDER</strong></tt>.</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb25"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>pq_select <span class="ot">&lt;-</span> <span class="st">&quot;$select=distinct release_year,director,title&quot;</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>pq_where <span class="ot">&lt;-</span> <span class="st">&quot;&amp;$where=release_year=2016&quot;</span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>pq_order <span class="ot">&lt;-</span> <span class="st">&quot;&amp;$order=release_year,director&quot;</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>filmloc_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(movie_loc_url <span class="sc">|&gt;</span> </span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>                             <span class="fu">paste0</span>(pq_select, pq_where, pq_order) <span class="sc">|&gt;</span> </span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a>                             <span class="fu">URLencode</span>())</span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="fu">kable</span>(filmloc_df)</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align:left;">
release_year
</th>
<th style="text-align:left;">
director
</th>
<th style="text-align:left;">
title
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:left;">
Alexandra Cunningham and Kem Nunn
</td>
<td style="text-align:left;">
Chance- Season 1 ep107
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:left;">
Alexandra Cunningham and Kem Nunn
</td>
<td style="text-align:left;">
Chance- Season 1 ep110
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:left;">
Andrew Haigh
</td>
<td style="text-align:left;">
Looking "Special"
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:left;">
Carl Franklin
</td>
<td style="text-align:left;">
Chance- Season 1 ep104
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:left;">
George Nolfi
</td>
<td style="text-align:left;">
Birth of the Dragon
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:left;">
Lenny Abrahamson
</td>
<td style="text-align:left;">
Chance- Season 1 ep102
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:left;">
Lenny Abrahamson
</td>
<td style="text-align:left;">
Chance - Season 1 Pilot
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:left;">
Michael Lehmann
</td>
<td style="text-align:left;">
Chance- Season 1 ep103
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:left;">
Peter Elkoff and Victoria Morrow
</td>
<td style="text-align:left;">
Chance- Season 1 ep108
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:left;">
Sara Gran
</td>
<td style="text-align:left;">
Chance- Season 1 ep106
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:left;">
Sara Gran and Pete Begler
</td>
<td style="text-align:left;">
Chance- Season 1 ep109
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:left;">
Steven Bochcho
</td>
<td style="text-align:left;">
Murder in the First, Season 3
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:left;">
Tom Brown
</td>
<td style="text-align:left;">
Pushing Dead
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:left;">
Victoria Morrow
</td>
<td style="text-align:left;">
Chance - Season 1ep105
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:left;">
Victoria Morrow
</td>
<td style="text-align:left;">
Chance - Season 1 ep105
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:left;">
Wachowski Siblings
</td>
<td style="text-align:left;">
Sense8 - Season 2
</td>
</tr>
</tbody>
</table>
</div>
<p><br />
</p>
</div>
<div id="calculated-expressions-and-summaries"
class="slide section level1">
<h1>Calculated Expressions and Summaries</h1>
<p>The real power of SoQL queries is not just retrieving data, but
letting the server do calculations for you!</p>
<p>In addition to field names, the SELECT expression can also include
calculated expressions, including count, sum, avg, min, and max. The
arguments for these equations is usually a field name, or an expression
that uses fields.</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb26"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="do">## Define a select statement that will count the number of records and </span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="do">## sum up the release year values</span></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>pq_select <span class="ot">&lt;-</span> <span class="st">&quot;$select=count(release_year) as num_locations,sum(release_year)&quot;</span></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>filmloc_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(movie_loc_url <span class="sc">|&gt;</span> </span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>                             <span class="fu">paste0</span>(pq_select) <span class="sc">|&gt;</span> </span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>                             <span class="fu">URLencode</span>())</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>filmloc_df</span></code></pre></div>
<pre><code>##   num_locations sum_release_year
## 1          2084          4174981</code></pre>
</div>
<p><br />
</p>
<div class="tip">
<p>Note the use of the ‘AS’ keyword above, which allows you to rename a
column in the results (aka alias)</p>
</div>
<!--- tip --->
<div class="quiz">
<p>Which years are included in the above query?</p>
<p><span id="soln_uukvuc" class="showhidesoln"
onclick="showHide(&#39;uukvuc&#39;);return false;">Answer</span></p>
<div id="uukvuc" class="hint">
<p><strong>All of them</strong> (because there’s no where clause).</p>
</div>
<!--- soln_uukvuc --->
</div>
<!--- quiz --->
<p>The <tt><strong>GROUP</strong></tt> clause allows you to group rows
on a field. It comes <em>after</em> the SELECT clause but
<em>before</em> the WHERE clause. When you use GROUP, the SELECT clause
often includes a calculated expression.</p>
<div class="indented2">
<strong>Note</strong>: using GROUP clause <strong>also requires</strong>
adding the <strong>ORDER</strong> clause.
</div>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb28"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="do">## Count the number of film shoots per year in the 1970s</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>pq_select <span class="ot">&lt;-</span> <span class="st">&quot;$select=release_year,count(title)&quot;</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>pq_group <span class="ot">&lt;-</span> <span class="st">&quot;&amp;$group=release_year&quot;</span></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>pq_where <span class="ot">&lt;-</span> <span class="st">&quot;&amp;$where=release_year BETWEEN 1970 and 1979&quot;</span></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>pq_order <span class="ot">&lt;-</span> <span class="st">&quot;&amp;$order=release_year&quot;</span></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>filmloc_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(movie_loc_url <span class="sc">|&gt;</span> </span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>                             <span class="fu">paste0</span>(pq_select, pq_group, pq_where, pq_order) <span class="sc">|&gt;</span> </span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>                             <span class="fu">URLencode</span>())</span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a>filmloc_df</span></code></pre></div>
<pre><code>##   release_year count_title
## 1         1970           1
## 2         1971          19
## 3         1972          14
## 4         1973          18
## 5         1974          34
## 6         1976          13
## 7         1977           3
## 8         1978          45
## 9         1979          25</code></pre>
</div>
<p><br />
</p>
<div class="tip">
<p>In general, the order of SoQL clauses should be:</p>
<div class="indented1 compact">
<ol style="list-style-type: decimal">
<li><tt>select</tt><br />
</li>
<li><tt>group</tt><br />
</li>
<li><tt>where</tt><br />
</li>
<li><tt>order</tt><br />
</li>
<li><tt>limit</tt></li>
</ol>
</div>
</div>
<!--- tip --->
<div class="tryit">
<p>Which director shot in the most number of locations in the 1970s?</p>
<p>[<span id="soln_mbzcoz" class="showhidesoln"
onclick="showHide(&#39;mbzcoz&#39;);return false;">Solution</span>]</p>
<div id="mbzcoz" class="hint">
<div class="sourceCode" id="cb30"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="do">## Count the number of film locations by director </span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>pq_select <span class="ot">&lt;-</span> <span class="st">&quot;$select=director,count(title) as num_locations&quot;</span></span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>pq_group <span class="ot">&lt;-</span> <span class="st">&quot;&amp;$group=director&quot;</span></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>pq_where <span class="ot">&lt;-</span> <span class="st">&quot;&amp;$where=release_year BETWEEN 1970 and 1979&quot;</span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>pq_order <span class="ot">&lt;-</span> <span class="st">&quot;&amp;$order=num_locations desc&quot;</span></span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a>filmloc_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(movie_loc_url <span class="sc">|&gt;</span> </span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a>                             <span class="fu">paste0</span>(pq_select, pq_group, pq_where, pq_order) <span class="sc">|&gt;</span> </span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>                             <span class="fu">URLencode</span>())</span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a><span class="fu">head</span>(filmloc_df)</span></code></pre></div>
<pre><code>##         director num_locations
## 1 Nicholas Meyer            24
## 2  Colin Higgins            22
## 3 Philip Kaufman            16
## 4     Don Siegel            15
## 5       Ted Post            15
## 6   Richard Rush            13</code></pre>
<p>⇒ <strong>Nicholas Meyer</strong> shot in the most locations.</p>
<p>Note the inclusion of <tt><strong>as</strong></tt> in the select
clause to give the calculated column a custom name, and
<tt><strong>desc</strong></tt> in the order clause to order the rows in
descending order.</p>
</div>
<!--- soln_mbzcoz --->
</div>
<!--- TryIt --->
<div class="infobox">
<p>If you need even more data munging, you can pass a full fledged SQL
expression as the <a
href="https://dev.socrata.com/docs/queries/query.html"
target="_blank">query</a> clause.</p>
</div>
<!--- info-box --->
</div>
<div id="example-fire-department-calls-for-service"
class="slide section level1">
<h1>Example: Fire Department Calls for Service</h1>
<p>In this example, we’ll compute the number of 911 calls by
neibhgorhood for a one week. We’ll then plot them on chloropleth
map.</p>
<div class="tip">
<p>General workflow</p>
<div class="compact">
<ol style="list-style-type: decimal">
<li>Find the data page for the Fire Dept Calls.<br />
</li>
<li>Read about the columns &amp; get the API URL.<br />
</li>
<li>Write a SoQL expression that will return distinct incident numbers
and neighborhood names.<br />
</li>
<li>Use dplyr to compute the number of incidents per neighborhood.</li>
<li>Download the neighborhood boundaries.<br />
</li>
<li>Use dplyr to join the incidents-per-neighborhood table to the
neighborhood boundaries attribute table, linking them by the
neighborhood name.<br />
</li>
<li>Make the map.<br />
</li>
</ol>
</div>
</div>
<!--- tip --->
<p>1. The <a
href="https://data.sfgov.org/Public-Safety/Fire-Department-Calls-for-Service/nuek-vuh3"
target="_blank">Fire Department Calls for Service</a> page tells us:</p>
<div class="compact">
<ul>
<li>The rows actually represent responses, not calls, So we’ll have to
eliminate duplicates by grouping on the incident number.<br />
</li>
<li>There are over 5 million rows, so we definitely don’t want to
download them all!</li>
<li>The date of the call is stored in a column called
<tt><strong>call_date</strong></tt>, which is a <a
href="https://dev.socrata.com/docs/datatypes/floating_timestamp.html"
target="_blank">floating timestamp</a>. That means when we write the
<strong>where</strong> clause to filter it, we need to specify both date
and time.</li>
</ul>
</div>
<p>2. URL for the API:</p>
<div class="indented3">
<tt><a href="https://data.sfgov.org/resource/nuek-vuh3.json"
class="uri">https://data.sfgov.org/resource/nuek-vuh3.json</a></tt>
</div>
<p>We also see there is a geojson version. But in this case we’re not
really interested in the exact locations, just the neighborhood name
(which is saved in column
<tt>neighborhoods_analysis_boundaries</tt>).</p>
<p>3. Write a SoQL expression.</p>
<p>We’ll build our expression in stages. First let’s just see if we can
select a few records using the <strong>select</strong> and
<strong>limit</strong> clauses:</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb32"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>ems_resp_url <span class="ot">&lt;-</span> <span class="st">&quot;https://data.sfgov.org/resource/nuek-vuh3.json?&quot;</span></span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a><span class="do">## Select the fields we&#39;ll need </span></span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>pq_select <span class="ot">&lt;-</span> <span class="st">&quot;$select=call_date,incident_number,neighborhoods_analysis_boundaries&quot;</span></span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>pq_limit <span class="ot">&lt;-</span> <span class="st">&quot;&amp;$limit=10&quot;</span></span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a>ems_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(ems_resp_url <span class="sc">|&gt;</span> </span>
<span id="cb32-8"><a href="#cb32-8" tabindex="-1"></a>                             <span class="fu">paste0</span>(pq_select, pq_limit) <span class="sc">|&gt;</span> </span>
<span id="cb32-9"><a href="#cb32-9" tabindex="-1"></a>                             <span class="fu">URLencode</span>())</span>
<span id="cb32-10"><a href="#cb32-10" tabindex="-1"></a><span class="fu">glimpse</span>(ems_df) </span></code></pre></div>
<PRE class="fansi fansi-output"><CODE>## Rows: 10
## Columns: 3
## $ call_date                         <span style='color: #949494; font-style: italic;'>&lt;dttm&gt;</span> 2006-12-17, 2006-12-17, 2006-12-17, 2006-12-17, 2006-12-17, 2006-12-17, 2006-12-1…
## $ incident_number                   <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;06099100&quot;, &quot;06099101&quot;, &quot;06099101&quot;, &quot;06099101&quot;, &quot;06099102&quot;, &quot;06099103&quot;, &quot;06099104&quot;…
## $ neighborhoods_analysis_boundaries <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;Glen Park&quot;, &quot;Chinatown&quot;, &quot;Chinatown&quot;, &quot;Chinatown&quot;, &quot;Tenderloin&quot;, &quot;South of Market…
</CODE></PRE>
</div>
<p><br />
</p>
<p>Next, let swap the <strong>limit</strong> clause with a
<strong>where</strong> clause to filter the results on
<tt><strong>call_date</strong></tt>:</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb33"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>pq_where <span class="ot">&lt;-</span> <span class="st">&quot;&amp;$where=call_date between &#39;2019-10-01T00:00:00&#39; and &#39;2019-10-07T23:59:59&#39;&quot;</span></span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a>ems_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(ems_resp_url <span class="sc">|&gt;</span> </span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a>                             <span class="fu">paste0</span>(pq_select, pq_where) <span class="sc">|&gt;</span> </span>
<span id="cb33-5"><a href="#cb33-5" tabindex="-1"></a>                             <span class="fu">URLencode</span>())</span>
<span id="cb33-6"><a href="#cb33-6" tabindex="-1"></a><span class="fu">glimpse</span>(ems_df) </span></code></pre></div>
<PRE class="fansi fansi-output"><CODE>## Rows: 6,469
## Columns: 3
## $ call_date                         <span style='color: #949494; font-style: italic;'>&lt;dttm&gt;</span> 2019-10-01, 2019-10-01, 2019-10-01, 2019-10-01, 2019-10-01, 2019-10-01, 2019-10-0…
## $ incident_number                   <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;19117546&quot;, &quot;19117546&quot;, &quot;19117547&quot;, &quot;19117547&quot;, &quot;19117547&quot;, &quot;19117548&quot;, &quot;19117548&quot;…
## $ neighborhoods_analysis_boundaries <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;Financial District/South Beach&quot;, &quot;Financial District/South Beach&quot;, &quot;South of Mark…
</CODE></PRE>
</div>
<p><br />
</p>
<p>Lastly we add <tt><strong>distinct</strong></tt> to the
<strong>select</strong> clause so we get unique combinations of
neighborhood name and incident number. As noted before, when using
‘distinct’ we also need to add the <tt><strong>order</strong></tt>
clause:</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb34"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="do">## Download unique rows for neighborhood &amp; incident id</span></span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a>pq_select <span class="ot">&lt;-</span> <span class="st">&quot;$select=distinct neighborhoods_analysis_boundaries as nhood,incident_number&quot;</span></span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a>pq_order <span class="ot">&lt;-</span> <span class="st">&quot;&amp;$order=neighborhoods_analysis_boundaries&quot;</span></span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a>ems_df <span class="ot">&lt;-</span> <span class="fu">read.socrata</span>(ems_resp_url <span class="sc">|&gt;</span> </span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a>                             <span class="fu">paste0</span>(pq_select, pq_where, pq_order) <span class="sc">|&gt;</span> </span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a>                             <span class="fu">URLencode</span>())</span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a><span class="fu">glimpse</span>(ems_df)</span></code></pre></div>
<PRE class="fansi fansi-output"><CODE>## Rows: 3,041
## Columns: 2
## $ nhood           <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;Bayview Hunters Point&quot;, &quot;Bayview Hunters Point&quot;, &quot;Bayview Hunters Point&quot;, &quot;Bayview Hunters Point&quot;, …
## $ incident_number <span style='color: #949494; font-style: italic;'>&lt;chr&gt;</span> &quot;19117577&quot;, &quot;19117601&quot;, &quot;19117622&quot;, &quot;19117635&quot;, &quot;19117648&quot;, &quot;19117654&quot;, &quot;19117695&quot;, &quot;19117697&quot;, &quot;191…
</CODE></PRE>
</div>
<p><br />
</p>
<div class="infobox">
<p>Because the rows represent responses, and the SoQL language doesn’t
have a function like <em>count_distinct()</em>, we’ll have to count up
the records in R.</p>
</div>
<!--- info-box --->
<p>4. In R, we can now count the number of incidents per
neighborhood:</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb35"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="do">## Compute the number of incidents per neighborhood</span></span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a>nb_num_calls <span class="ot">&lt;-</span> ems_df <span class="sc">|&gt;</span> </span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(nhood) <span class="sc">|&gt;</span> </span>
<span id="cb35-4"><a href="#cb35-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">num_calls =</span> <span class="fu">n</span>())</span>
<span id="cb35-5"><a href="#cb35-5" tabindex="-1"></a>nb_num_calls</span></code></pre></div>
<pre><code>## # A tibble: 42 × 2
##    nhood                          num_calls
##    &lt;chr&gt;                              &lt;int&gt;
##  1 Bayview Hunters Point                139
##  2 Bernal Heights                        38
##  3 Castro/Upper Market                   78
##  4 Chinatown                             50
##  5 Excelsior                             57
##  6 Financial District/South Beach       263
##  7 Glen Park                             23
##  8 Golden Gate Park                      37
##  9 Haight Ashbury                        40
## 10 Hayes Valley                          56
## # ℹ 32 more rows</code></pre>
</div>
<p><br />
</p>
<p>5.Download the neighborhood boundaries. This is a geojson object so
we use <tt><strong>sf::read_sf</strong></tt>.</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb37"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="do">## Download the neighborhood boundaries</span></span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a>nb_bnd <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;https://data.sfgov.org/resource/j2bu-swwd.geojson&quot;</span> <span class="sc">|&gt;</span> <span class="fu">URLencode</span>())</span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a><span class="fu">glimpse</span>(nb_bnd)</span></code></pre></div>
<pre><code>## Rows: 41
## Columns: 2
## $ nhood    &lt;chr&gt; &quot;Western Addition&quot;, &quot;West of Twin Peaks&quot;, &quot;Visitacion Valley&quot;, &quot;Twin Peaks&quot;, &quot;South of Market&quot;, &quot;Treasure I…
## $ geometry &lt;MULTIPOLYGON [°]&gt; MULTIPOLYGON (((-122.4214 3..., MULTIPOLYGON (((-122.461 37..., MULTIPOLYGON (((-122.4039 3...…</code></pre>
</div>
<p><br />
</p>
<p>6. Use <strong>dplyr</strong> to join the incidents-per-neighborhood
table to the neighborhood boundaries attribute table, linking them by
the neighboorhood name column (conveniently called ‘nhood’ in both
tables).</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb39"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a><span class="do">## Join nb_num_calls to the attribute table of nb_bnd, so the </span></span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a><span class="do">## column(s) in nb_num_calls will be availabe for symbolization.</span></span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a>nb_bnd <span class="ot">&lt;-</span> nb_bnd <span class="sc">|&gt;</span> <span class="fu">left_join</span>(nb_num_calls)</span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a><span class="fu">head</span>(nb_bnd)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 2 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -122.4761 ymin: 37.70833 xmax: -122.3588 ymax: 37.8333
## Geodetic CRS:  WGS 84
## # A tibble: 6 × 3
##   nhood                                                                                             geometry num_calls
##   &lt;chr&gt;                                                                                   &lt;MULTIPOLYGON [°]&gt;     &lt;int&gt;
## 1 Western Addition   (((-122.4214 37.78557, -122.4214 37.78521, -122.4213 37.78486, -122.4212 37.78475, -...        66
## 2 West of Twin Peaks (((-122.461 37.75096, -122.4606 37.74994, -122.4604 37.74976, -122.4596 37.74902, -1...        80
## 3 Visitacion Valley  (((-122.4039 37.71883, -122.4036 37.71834, -122.4031 37.71846, -122.4021 37.71872, -...        30
## 4 Twin Peaks         (((-122.4469 37.75655, -122.4459 37.75641, -122.4458 37.75642, -122.4456 37.75645, -...         8
## 5 South of Market    (((-122.4037 37.78404, -122.4027 37.78326, -122.4005 37.78503, -122.3999 37.78456, -...       368
## 6 Treasure Island    (((-122.3636 37.82087, -122.3605 37.82012, -122.3606 37.8198, -122.3636 37.82054, -1...         9</code></pre>
</div>
<p><br />
</p>
<p>7. Finally, make the map.</p>
<p>We’ll make the map with tmap, which offers the greatest number of
options.</p>
<div class="indented2 indented2r">
<div class="sourceCode" id="cb41"><pre
class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a><span class="do">## Make a choropleth map</span></span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a><span class="fu">tm_shape</span>(nb_bnd) <span class="sc">+</span> </span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">col=</span><span class="st">&#39;num_calls&#39;</span>, <span class="at">title=</span><span class="st">&quot;Num 911 calls&quot;</span>, <span class="at">n=</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a>  <span class="fu">tm_legend</span>(<span class="at">legend.outside=</span>T) <span class="sc">+</span></span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title=</span><span class="st">&quot;911 Calls, Oct 1-7 2019&quot;</span>,</span>
<span id="cb41-7"><a href="#cb41-7" tabindex="-1"></a>            <span class="at">main.title.size =</span> <span class="fl">1.5</span>,</span>
<span id="cb41-8"><a href="#cb41-8" tabindex="-1"></a>            <span class="at">main.title.fontface =</span> <span class="dv">2</span>,</span>
<span id="cb41-9"><a href="#cb41-9" tabindex="-1"></a>            <span class="at">main.title.fontfamily =</span> <span class="st">&quot;serif&quot;</span>)</span></code></pre></div>
<p><img src="socrata-api_files/figure-slidy/nb_map_klippy-1.png" width="768" /></p>
</div>
</div>
<div id="summary" class="slide section level1">
<h1>Summary</h1>
<p>Today we saw:</p>
<div class="compact">
<ul>
<li>how to import data with Socrata</li>
</ul>
</div>
<div class="infobox">
<p><strong>Additional Resources</strong></p>
<div class="indented1">
<p><a href="https://datasf.org" target="_blank">SF Open Data
Portal</a></p>
<p><a href="http://datasf.org/opendata/developers" target="_blank">SF
Open Data Developer Resources</a> (go here to get an API token)</p>
<p><a href="https://dev.socrata.com/docs/queries/" target="_blank">SoQL
Query Language</a></p>
</div>
</div>
</div>

  <!-- dynamically load mathjax for compatibility with self-contained -->
  <script>
    (function () {
      var script = document.createElement("script");
      script.type = "text/javascript";
      script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
      document.getElementsByTagName("head")[0].appendChild(script);
    })();
  </script>

</body>
</html>
